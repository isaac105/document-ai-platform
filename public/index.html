<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì‚¬ë‚´ ë¬¸ì„œ ì •ë¦¬ AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: #111;
        background-color: #f5f5f7;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 32px 16px 80px;
      }

      .app {
        width: min(960px, 100%);
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      h1 {
        margin: 0;
        font-size: 1.75rem;
      }

      section {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 15px 40px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(15, 23, 42, 0.06);
      }

      .section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .section-title h2 {
        margin: 0;
        font-size: 1.2rem;
      }

      label {
        font-size: 0.9rem;
        color: #475467;
      }

      input,
      textarea,
      button,
      select {
        font: inherit;
      }

      .file-input-wrapper {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .file-drop {
        border: 1px dashed #cbd5f5;
        border-radius: 16px;
        padding: 20px;
        background: linear-gradient(135deg, #eef2ff, #f8fafc);
        display: flex;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        transition: border 0.2s ease, background 0.2s ease;
      }

      .file-drop:hover {
        border-color: #818cf8;
        background: linear-gradient(135deg, #e0e7ff, #f5f7ff);
      }

      .file-drop .file-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(99, 102, 241, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #4f46e5;
      }

      .file-drop-content {
        flex: 1;
      }

      .file-drop button {
        background: #4f46e5;
        color: #fff;
        border-radius: 999px;
        padding: 8px 18px;
        border: none;
      }

      .file-name {
        font-weight: 600;
        color: #1f2937;
      }

      .file-hint {
        font-size: 0.85rem;
        color: #6b7280;
      }

      input[type='text'],
      textarea,
      select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #d0d5dd;
        background: #fff;
        transition: border 0.2s ease;
        box-sizing: border-box;
      }

      input[type='text']:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      button {
        padding: 12px 18px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button.primary {
        background: #111827;
        color: #fff;
        box-shadow: 0 10px 20px rgba(17, 24, 39, 0.2);
      }

      button.secondary {
        background: #e5e7eb;
        color: #111827;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      button:not(:disabled):active {
        transform: scale(0.98);
      }

      .muted {
        font-size: 0.85rem;
        color: #94a3b8;
      }

      .documents-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 260px;
        overflow-y: auto;
      }

      .document-card {
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 14px;
        padding: 14px 16px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .document-card h3 {
        margin: 0;
        font-size: 1rem;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 10px;
        font-size: 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge.status-completed {
        color: #15803d;
        background: #dcfce7;
        border-color: #86efac;
      }

      .badge.status-processing {
        color: #b45309;
        background: #fef3c7;
        border-color: #fcd34d;
      }

      .badge.status-pending {
        color: #1d4ed8;
        background: #dbeafe;
        border-color: #93c5fd;
      }

      .answer-box {
        min-height: 150px;
        white-space: pre-line;
        border-radius: 12px;
        background: #f8fafc;
        padding: 16px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        margin-top: 16px;
      }

      .upload-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .meta-field {
        flex: 1;
        min-width: 220px;
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 14px 18px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .meta-field span {
        font-size: 0.9rem;
        color: #475467;
      }

      .meta-field input {
        flex: 1;
        border-radius: 12px;
        border: 1px solid #d0d5dd;
        padding: 10px 12px;
      }

      @media (max-width: 600px) {
        section {
          padding: 20px;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>ì‚¬ë‚´ ë¬¸ì„œ ì •ë¦¬ AI</h1>
        <p class="muted">
          ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³  ì§ˆë¬¸ì„ ë˜ì ¸ë³´ì„¸ìš”. ë²¡í„° ê¸°ë°˜ LLMì´ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
        </p>
      </header>

      <section>
        <div class="section-title">
          <h2>1. ë¬¸ì„œ ì—…ë¡œë“œ</h2>
          <span class="muted">PDF / Word / TXT</span>
        </div>
        <form id="uploadForm">
          <div class="upload-grid">
            <div class="file-input-wrapper">
              <input type="file" id="fileInput" hidden accept=".pdf,.doc,.docx,.txt" required />
              <label class="file-drop" for="fileInput">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-drop-content">
                  <div class="file-name" id="fileNameDisplay">
                    íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”
                  </div>
                  <div class="file-hint">
                    ì§€ì› í™•ì¥ì: PDF, DOC, DOCX, TXT (ìµœëŒ€ 10MB)
                  </div>
                </div>
              </label>
            </div>
            <div class="meta-row">
              <label class="meta-field">
                <span>íŒ€ëª… (ì„ íƒ)</span>
                <select id="teamInput">
                  <option value="">ì „ì²´</option>
                  <option value="ê²½ì˜ì§€ì›íŒ€">ê²½ì˜ì§€ì›íŒ€</option>
                  <option value="ê°œë°œíŒ€">ê°œë°œíŒ€</option>
                  <option value="ê¸°íšíŒ€">ê¸°íšíŒ€</option>
                  <option value="ë””ìì¸íŒ€">ë””ìì¸íŒ€</option>
                  <option value="ì˜ì—…íŒ€">ì˜ì—…íŒ€</option>
                  <option value="ì¸ì‚¬íŒ€">ì¸ì‚¬íŒ€</option>
                </select>
              </label>
              <label class="meta-field">
                <span>ì—…ë¡œë” (ì„ íƒ)</span>
                <input type="text" id="uploadedByInput" placeholder="ì˜ˆ: ìµëª…" />
              </label>
            </div>
          </div>
          <button class="primary" type="submit">ë¬¸ì„œ ì—…ë¡œë“œ</button>
          <p id="uploadStatus" class="muted"></p>
        </form>
      </section>

      <section>
        <div class="section-title">
          <h2>2. ë¬¸ì„œ ëª©ë¡</h2>
          <button class="secondary" id="refreshDocs">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="documentsList" class="documents-list"></div>
      </section>

      <section>
        <div class="section-title">
          <h2>3. ì§ˆë¬¸í•˜ê¸°</h2>
          <span class="muted">ìµœì‹  ì™„ë£Œ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€</span>
        </div>
        <form id="questionForm">
          <label>
            <span>íŒ€ í•„í„° (ì„ íƒ)</span><br />
            <select id="questionTeam">
              <option value="">ì „ì²´</option>
              <option value="ê²½ì˜ì§€ì›íŒ€">ê²½ì˜ì§€ì›íŒ€</option>
              <option value="ê°œë°œíŒ€">ê°œë°œíŒ€</option>
              <option value="ê¸°íšíŒ€">ê¸°íšíŒ€</option>
              <option value="ë””ìì¸íŒ€">ë””ìì¸íŒ€</option>
              <option value="ì˜ì—…íŒ€">ì˜ì—…íŒ€</option>
              <option value="ì¸ì‚¬íŒ€">ì¸ì‚¬íŒ€</option>
            </select>
          </label>
          <label>
            <span>ì§ˆë¬¸</span><br />
            <textarea id="questionInput" placeholder="ì˜ˆ: ì‹ ê·œ ì˜¨ë³´ë”© ì ˆì°¨ ìš”ì•½í•´ì¤˜" required></textarea>
          </label>
          <button class="primary" type="submit">ë‹µë³€ ìš”ì²­</button>
          <p id="questionStatus" class="muted"></p>
        </form>
        <div class="answer-box" id="answerBox">
          ì•„ì§ ì§ˆë¬¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³  ì§ˆë¬¸ì„ ë˜ì ¸ë³´ì„¸ìš”.
        </div>
      </section>
    </div>

    <script>
      const documentsList = document.getElementById('documentsList');
      const refreshDocsBtn = document.getElementById('refreshDocs');
      const uploadForm = document.getElementById('uploadForm');
      const uploadStatus = document.getElementById('uploadStatus');
      const questionForm = document.getElementById('questionForm');
      const questionStatus = document.getElementById('questionStatus');
      const answerBox = document.getElementById('answerBox');
      const fileInput = document.getElementById('fileInput');
      const fileNameDisplay = document.getElementById('fileNameDisplay');

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        fileNameDisplay.textContent = file ? file.name : 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”';
      });

      async function fetchDocuments() {
        documentsList.innerHTML = '<p class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        const res = await fetch('/documents');
        const data = await res.json();
        if (!data.data?.length) {
          documentsList.innerHTML = '<p class="muted">ì•„ì§ ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        documentsList.innerHTML = data.data
          .map(
            (doc) => `
          <div class="document-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3>${doc.originalName}</h3>
              <span style="font-size:12px; color:#888;">
                ì—…ë¡œë”: ${doc.team ? `${doc.team}/${doc.uploadedBy}` : 'ìµëª…'}
              </span>
              <span class="badge status-${doc.status}">${doc.status}</span>
            </div>
            <p class="muted">${(doc.fileSize / 1024).toFixed(1)} KB â€¢ ${new Date(doc.updatedAt).toLocaleString()}</p>
            <p>${doc.summary ?? 'ìš”ì•½ ëŒ€ê¸° ì¤‘'}</p>
          </div>
        `,
          )
          .join('');
      }

      uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        const team = document.getElementById('teamInput').value || null;
        const uploadedBy = document.getElementById('uploadedByInput').value || 'ìµëª…';
        if (team) formData.append('team', team);
        if (uploadedBy) formData.append('uploadedBy', uploadedBy);

        uploadStatus.textContent = 'ì—…ë¡œë“œ ì¤‘...';
        try {
          const res = await fetch('/documents/upload', {
            method: 'POST',
            body: formData,
          });
          if (!res.ok) {
            throw new Error(await res.text());
          }
          uploadStatus.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ! í˜„ì¬ ì„œë²„ì—ì„œ ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
          fetchDocuments();
        } catch (error) {
          uploadStatus.textContent = `ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        }
      });

      refreshDocsBtn.addEventListener('click', fetchDocuments);

      const documentsEvents = new EventSource('/documents/events/stream');
      documentsEvents.onmessage = () => {
        fetchDocuments();
        uploadStatus.textContent = '';
      };
      documentsEvents.onerror = () => {
        console.warn('ë¬¸ì„œ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„ë©ë‹ˆë‹¤.');
      };

      questionForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const question = document.getElementById('questionInput').value.trim();
        if (!question) return;
        const team = document.getElementById('questionTeam').value.trim() || null;

        questionStatus.textContent = 'ë‹µë³€ ìƒì„± ì¤‘...';
        answerBox.textContent = '';

        try {
          const res = await fetch('/qa/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, team: team || undefined }),
          });
          if (!res.ok) {
            throw new Error(await res.text());
          }
          const data = await res.json();
          answerBox.textContent = data.answer;
          questionStatus.textContent =
            data.sources?.length
              ? `ì°¸ê³  ë¬¸ì„œ ${data.sources.length}ê±´ [` +
                data.sources
                  .map(
                    (source) => `${source.originalName}`,
                  )
                  .join(', ')
                + `]`
              : 'ì°¸ê³  ê°€ëŠ¥í•œ ë¬¸ì„œê°€ ì—†ì–´ ìš”ì•½ ë²”ìœ„ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.';
        } catch (error) {
          answerBox.textContent = 'ë‹µë³€ ìƒì„± ì‹¤íŒ¨: ' + error.message;
          questionStatus.textContent = '';
        }
      });

      fetchDocuments();
    </script>
  </body>
</html>

